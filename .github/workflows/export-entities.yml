name: Export entities snapshot
 
on:
  push:
    branches: [ develop ]
  workflow_dispatch:
 
permissions:
  contents: write
 
jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
 
      - name: Ensure script is present
        run: |
          mkdir -p scripts/export
          cat > scripts/export/export-entities.sh << 'EOF'
          #!/usr/bin/env bash
          set -euo pipefail
 
          OUT="docs/ai-entities.md"
          BRANCH="${GITHUB_REF_NAME:-develop}"
 
          mkdir -p docs
 
          {
            echo "# Entidades JPA — snapshot incrustado"
            echo
            echo "> Snapshot generado desde la rama \`$BRANCH\`. Contiene el **código completo** de cada entidad para revisión."
            echo
            echo "---"
            echo
          } > "$OUT"
 
          mapfile -t FILES < <(git ls-files 'src/main/java/**/domain/model/*.java' | sort)
 
          for f in "${FILES[@]}"; do
            echo "\`\`\`java" >> "$OUT"
            echo "// $f" >> "$OUT"
            cat "$f" >> "$OUT"
            echo "\`\`\`" >> "$OUT"
            echo >> "$OUT"
          done
 
          echo "Generado $OUT con ${#FILES[@]} archivo(s)."
          EOF
          chmod +x scripts/export/export-entities.sh
 
      - name: Generate ai-entities.md
        run: scripts/export/export-entities.sh
 
      - name: Commit changes (if any)
        run: |
          if [[ -n "$(git status --porcelain docs/ai-entities.md)" ]]; then
            git config user.name "github-actions[bot]"
            git config user.email "github-actions[bot]@users.noreply.github.com"
            git add docs/ai-entities.md
            git commit -m "chore: update ai-entities.md snapshot [skip ci]"
            git push
          else
            echo "Sin cambios que commitear."
          fi
